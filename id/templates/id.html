<!-- templates/id.html -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>AVAILABLE ‚Ä¢ ID</title>
  <style>
    body { font-family: system-ui, sans-serif; background:#0b0b0b; color:#e6e6e6; margin:20px; }
    h1 { margin-bottom: 10px; }
    h2 { margin: 24px 0 8px; }
    table { width: 100%; border-collapse: collapse; background:#121212; }
    th, td { border: 1px solid #2a2a2a; padding: 8px 10px; font-size: 14px; vertical-align: middle; }
    th { background:#171717; text-align:left; }
    .actions { text-align:center; width: 90px; }
    .icon-btn { background:none; border:none; color:#e6e6e6; cursor:pointer; font-size:16px; padding:4px 6px; }
    .icon-btn:hover { color:#ff5bda; }
    .pwd-cell { white-space: nowrap; }
    .pwd-dot { letter-spacing: 2px; }
    .footer { margin-top: 8px; display: flex; justify-content: flex-end; }
    .pager { display: inline-flex; gap: 6px; align-items: center; }
    .pager a, .pager span { color:#cfcfcf; text-decoration: none; padding: 4px 8px; border: 1px solid #2a2a2a; border-radius: 4px; }
    .pager .current { background:#1f1f1f; font-weight: 600; }
    .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border:1px solid #2a2a2a; }
    .role-badge { display:inline-block; padding:3px 8px; border:1px solid #2a2a2a; border-radius:10px; font-size:12px; color:#9ffcff; }
    .tag-pill { display:inline-block; padding:3px 8px; border:1px solid #2a2a2a; border-radius:10px; font-size:12px; color:#e6e6e6; background:#1a1a1a; }
    .muted { color:#a7a7a7; }
  </style>
</head>
<body>
  <h1>AVAILABLE ‚Ä¢ Credentials & OTP</h1>

  <h2>Recent Accounts</h2>
  <table id="users-table">
    <thead>
      <tr>
        <th>Email</th>
        <th>Password</th>
        <th>Name</th>
        <th>Phone</th>
        <th>Tag</th>
        <th>Bio</th>
        <th>Role</th>
        <th>Image</th>
        <th>Created</th>
        <th class="actions">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for u in users_page.object_list %}
      <tr data-email="{{ u.email }}">
        <td>{{ u.email }}</td>
        <td class="pwd-cell">
          <span class="pwd pwd-dot" data-plain="{{ u.password_plain|default:'' }}">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
          <button class="icon-btn" title="Show/Hide" onclick="togglePwd(this)">üëÅ</button>
        </td>
        <td>{{ u.name }}</td>
        <td>{{ u.phone_number }}</td>
        <td>{% if u.tag %}<span class="tag-pill">#{{ u.tag }}</span>{% else %}-{% endif %}</td>
        <td>{{ u.bio }}</td>
        <td>{% if u.role %}<span class="role-badge">{{ u.role|upper }}</span>{% else %}-{% endif %}</td>
        <td>{% if u.profile_image %}<img src="{{ u.profile_image.url }}" class="avatar" alt="avatar">{% else %}-{% endif %}</td>
        <td class="muted">{{ u.created_at }}</td>
        <td class="actions">
          <button class="icon-btn" title="Delete user" onclick="deleteUser('{{ u.email }}', this)">üóë</button>
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="10">No accounts yet</td></tr>
      {% endfor %}
    </tbody>
  </table>
  <div class="footer">
    <nav class="pager" aria-label="Users pagination">
      {% if users_page.has_previous %}
        <a href="?u={{ users_page.previous_page_number }}&o={{ otps_page.number }}">Prev</a>
      {% endif %}
      {% for num in users_page.paginator.page_range %}
        {% if num == users_page.number %}
          <span class="current">{{ num }}</span>
        {% else %}
          <a href="?u={{ num }}&o={{ otps_page.number }}">{{ num }}</a>
        {% endif %}
      {% endfor %}
      {% if users_page.has_next %}
        <a href="?u={{ users_page.next_page_number }}&o={{ otps_page.number }}">Next</a>
      {% endif %}
    </nav>
  </div>

  <h2>Recent OTPs</h2>
  <table id="otps-table">
    <thead>
      <tr>
        <th>Email</th>
        <th>Code</th>
        <th>Created</th>
        <th>Expires</th>
        <th>Verified</th>
        <th class="actions">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for o in otps_page.object_list %}
      <tr data-otp-id="{{ o.id }}">
        <td>{{ o.email }}</td>
        <td><code>{{ o.code }}</code></td>
        <td class="muted">{{ o.created_at }}</td>
        <td class="muted">{{ o.expires_at }}</td>
        <td>{{ o.is_verified }}</td>
        <td class="actions">
          <button class="icon-btn" title="Delete OTP" onclick="deleteOtp({{ o.id }}, this)">üóë</button>
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="6">No OTPs yet</td></tr>
      {% endfor %}
    </tbody>
  </table>
  <div class="footer">
    <nav class="pager" aria-label="OTPs pagination">
      {% if otps_page.has_previous %}
        <a href="?u={{ users_page.number }}&o={{ otps_page.previous_page_number }}">Prev</a>
      {% endif %}
      {% for num in otps_page.paginator.page_range %}
        {% if num == otps_page.number %}
          <span class="current">{{ num }}</span>
        {% else %}
          <a href="?u={{ users_page.number }}&o={{ num }}">{{ num }}</a>
        {% endif %}
      {% endfor %}
      {% if otps_page.has_next %}
        <a href="?u={{ users_page.number }}&o={{ otps_page.next_page_number }}">Next</a>
      {% endif %}
    </nav>
  </div>

  <script>
    function togglePwd(btn) {
      const span = btn.closest('td').querySelector('.pwd');
      const plain = span.getAttribute('data-plain') || '';
      if (!plain) return;
      if (span.classList.contains('pwd-dot')) { span.textContent = plain; span.classList.remove('pwd-dot'); }
      else { span.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'; span.classList.add('pwd-dot'); }
    }
    async function deleteUser(email, btn) {
      if (!confirm('Delete user ' + email + '?')) return;
      try {
        const res = await fetch('/api/auth/delete-user/', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({email})
        });
        const data = await res.json();
        if (data.success) {
          const tr = btn.closest('tr');
          tr.parentNode.removeChild(tr);
        } else {
          alert(data.message || 'Delete failed');
        }
      } catch (e) {
        alert('Network error: ' + e);
      }
    }
    async function deleteOtp(id, btn) {
      if (!confirm('Delete OTP #' + id + '?')) return;
      try {
        const res = await fetch('/api/auth/delete-otp/', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({id})
        });
        const data = await res.json();
        if (data.success) {
          const tr = btn.closest('tr');
          tr.parentNode.removeChild(tr);
        } else {
          alert(data.message || 'Delete failed');
        }
      } catch (e) {
        alert('Network error: ' + e);
      }
    }
  </script>
</body>
</html>
